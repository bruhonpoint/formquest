<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Tr·∫Øc Nghi·ªám Generator</title>
  <style>
    :root {
      --blue: #2c7be5;
      --green: #28a745;
      --red: #ffbaba;
      --pastel1: #f0f8ff;
      --pastel2: #e6f0ff;
      --pastel3: #fffaf0;
      --correct-bg: #d4edda;
      --incorrect-bg: #f8d7da;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: var(--pastel1);
      max-width: 800px;
      margin: auto;
      padding: 20px;
      font-size: 16px;
      color: #333;
    }

    h1 {
      color: var(--blue);
    }

    .settings {
      margin-bottom: 15px;
      padding: 10px;
      background-color: var(--pastel2);
      border-radius: 8px;
    }

    .settings label {
      display: block;
      margin-bottom: 5px;
    }

    textarea {
      width: 100%;
      height: 200px;
      padding: 10px;
      font-family: monospace;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      background-color: white;
      box-sizing: border-box;
    }

    button {
      padding: 10px 15px;
      margin-top: 10px;
      font-size: 1rem;
      cursor: pointer;
      border: none;
      background-color: var(--blue);
      color: white;
      border-radius: 6px;
    }

    button:hover {
      background-color: #1a5ecc;
    }

    input[type="text"] {
      width: 100%;
      padding: 8px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }

    .question-block {
      margin-top: 20px;
      padding: 15px;
      border: 2px solid #add8e6;
      border-radius: 12px;
      background-color: var(--pastel3);
      transition: background-color 0.3s ease;
    }

    .question-block.correct {
      background-color: var(--correct-bg);
    }

    .question-block.incorrect {
      background-color: var(--incorrect-bg);
    }

    .choice {
      display: block;
      margin-bottom: 8px;
      font-size: 1.2rem;
      line-height: 1.6;
    }

    #quizContainer {
      margin-top: 30px;
    }

    #feedback {
      margin-top: 30px;
    }

    .feedback-card {
      background-color: #fff8e1;
      border-left: 5px solid var(--red);
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .feedback-card p {
      margin: 0 0 5px;
    }

    .feedback-card .correct-answer {
      color: var(--green);
      font-weight: bold;
    }

    @media (max-width: 600px) {
      body {
        font-size: 1.1rem;
        padding: 10px;
      }

      .choice {
        font-size: 1.25rem;
      }

      textarea, input[type="text"], button {
        width: 100%;
        font-size: 1rem;
      }

      .question-block {
        padding: 10px;
      }
    }
  </style>
</head>
<body>

  <h1>T·∫°o c√¢u h·ªèi tr·∫Øc nghi·ªám</h1>

  <div class="settings">
    <h3>‚öôÔ∏è Tu·ª≥ ch·ªânh:</h3>
    <label><input type="checkbox" id="shuffleQuestions" checked> X√°o tr·ªôn c√¢u h·ªèi</label>
    <label><input type="checkbox" id="shuffleChoices" checked> X√°o tr·ªôn ƒë√°p √°n</label>
  </div>

  <div id="inputSection">
    <p>D√°n c√¢u h·ªèi c·ªßa b·∫°n v√†o b√™n d∆∞·ªõi. M·ªói c√¢u g·ªìm 1 d√≤ng c√¢u h·ªèi v√† 4 d√≤ng ƒë√°p √°n, v√≠ d·ª•:</p>
    <pre>
C√¢u h·ªèi v√≠ d·ª•?
A. ƒê√°p √°n 1
*B. ƒê√°p √°n ƒë√∫ng
C. ƒê√°p √°n 3
D. ƒê√°p √°n 4
    </pre>

    <textarea id="inputText" placeholder="D√°n c√°c c√¢u h·ªèi v√†o ƒë√¢y..."></textarea>
    <br/>
    <button onclick="generateMCQs()">T·∫°o c√¢u h·ªèi</button>
  </div>

  <div id="editToggle" style="display:none;">
    <button onclick="showInput()">‚úèÔ∏è Ch·ªânh s·ª≠a c√¢u h·ªèi</button>
  </div>

  <div id="quizContainer"></div>
  <div id="feedback"></div>

  <div id="shareLink" style="display:none;">
    <p>üîó Chia s·∫ª b√†i tr·∫Øc nghi·ªám:</p>
    <input type="text" id="quizLink" readonly />
  </div>

  <script>
    let parsedQuestions = [];

    function shuffleArray(array) {
      return array.sort(() => Math.random() - 0.5);
    }

    function generateMCQs() {
      const input = document.getElementById("inputText").value.trim();
      const rawQuestions = input.split(/\n\s*\n/);
      parsedQuestions = [];

      const doShuffleQuestions = document.getElementById("shuffleQuestions").checked;
      const doShuffleChoices = document.getElementById("shuffleChoices").checked;

      rawQuestions.forEach(block => {
        const lines = block.split("\n").map(l => l.trim()).filter(Boolean);
        if (lines.length < 2) return;

        const questionText = lines[0];
        let choices = [];
        let correctIndex = -1;

        lines.slice(1).forEach((line, i) => {
          let text = line;
          if (line.startsWith("*")) {
            text = line.slice(1).trim();
            correctIndex = i;
          }
          choices.push(text);
        });

        if (doShuffleChoices) {
          const originalChoices = [...choices];
          const originalCorrectAnswer = originalChoices[correctIndex];
          choices = shuffleArray(choices);
          correctIndex = choices.indexOf(originalCorrectAnswer);
        }

        parsedQuestions.push({ question: questionText, choices, correct: correctIndex });
      });

      if (doShuffleQuestions) {
        parsedQuestions = shuffleArray(parsedQuestions);
      }

      renderQuiz();
      document.getElementById("inputSection").style.display = "none";
      document.getElementById("editToggle").style.display = "block";
      generateShareableLink();
    }

    function showInput() {
      document.getElementById("inputSection").style.display = "block";
      document.getElementById("editToggle").style.display = "none";
      document.getElementById("quizContainer").innerHTML = "";
      document.getElementById("feedback").innerHTML = "";
      document.getElementById("shareLink").style.display = "none";
    }

    function renderQuiz() {
      const quizContainer = document.getElementById("quizContainer");
      quizContainer.innerHTML = "";

      parsedQuestions.forEach((q, qIndex) => {
        const blockEl = document.createElement("div");
        blockEl.className = "question-block";
        blockEl.dataset.correct = q.correct;
        blockEl.dataset.index = qIndex;
        blockEl.innerHTML = `<p><strong>${q.question}</strong></p>`;

        q.choices.forEach((choice, cIndex) => {
          const inputId = `q${qIndex}c${cIndex}`;
          blockEl.innerHTML += `
            <label class="choice">
              <input type="radio" name="quiz${qIndex}" value="${cIndex}" id="${inputId}" />
              ${choice}
            </label>
          `;
        });

        quizContainer.appendChild(blockEl);
      });

      const checkAllBtn = document.createElement("button");
      checkAllBtn.textContent = "‚úÖ Ki·ªÉm tra";
      checkAllBtn.onclick = checkAllAnswers;
      quizContainer.appendChild(checkAllBtn);
    }

    function checkAllAnswers() {
      const blocks = document.querySelectorAll(".question-block");
      const feedback = document.getElementById("feedback");
      feedback.innerHTML = "";

      let incorrectList = [];

      blocks.forEach(block => {
        const qIndex = block.dataset.index;
        const correct = parseInt(block.dataset.correct);
        const selected = document.querySelector(`input[name="quiz${qIndex}"]:checked`);
        const question = parsedQuestions[qIndex];

        block.classList.remove("correct", "incorrect");

        if (selected && parseInt(selected.value) === correct) {
          block.classList.add("correct");
        } else {
          block.classList.add("incorrect");
          const correctAnswer = question.choices[correct];
          incorrectList.push(`
            <div class="feedback-card">
              <p><strong>${question.question}</strong></p>
              <p class="correct-answer">‚úÖ ƒê√°p √°n ƒë√∫ng: ${correctAnswer}</p>
            </div>
          `);
        }
      });

      if (incorrectList.length > 0) {
        feedback.innerHTML = `
          <h3>‚ùå B·∫°n tr·∫£ l·ªùi sai c√°c c√¢u sau:</h3>
          ${incorrectList.join("")}
        `;
      } else {
        feedback.innerHTML = `<h3>üéâ T·∫•t c·∫£ c√¢u ƒë·ªÅu ƒë√∫ng! Gi·ªèi qu√°!</h3>`;
      }
    }

    function generateShareableLink() {
      const urlData = JSON.stringify(parsedQuestions);
      const encodedData = encodeURIComponent(urlData);
      const link = `${window.location.origin}${window.location.pathname}?quiz=${encodedData}`;
      document.getElementById("quizLink").value = link;
      document.getElementById("shareLink").style.display = "block";
    }
  </script>

</body>
</html>
